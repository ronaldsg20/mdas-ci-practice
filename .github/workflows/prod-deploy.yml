name: PROD - Build and Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  docker-build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ghcr.io/${{ github.repository }}:latest
            ghcr.io/${{ github.repository }}:prod-${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  openshift-deploy:
    runs-on: ubuntu-latest
    needs: docker-build
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install OpenShift CLI
        run: |
          curl -LO https://mirror.openshift.com/pub/openshift-v4/clients/ocp/stable/openshift-client-linux.tar.gz
          tar -xzf openshift-client-linux.tar.gz
          sudo mv oc /usr/local/bin/
          oc version

      - name: Login to OpenShift
        run: |
          oc login --token=${{ secrets.OPENSHIFT_TOKEN }} --server=${{ secrets.OPENSHIFT_SERVER }}
          oc project rylangraham02-dev

      - name: Blue-Green Deployment
        run: |
          echo "üîé Detecting Active Environment..."
          # Get current active service from Route (defaults to 'none' if route missing)
          ACTIVE_SERVICE=$(oc get route prod-mdas-ci-practice -n rylangraham02-dev -o jsonpath='{.spec.to.name}' 2>/dev/null || echo "none")

          if [[ "$ACTIVE_SERVICE" == "prod-blue-mdas-ci-practice" ]]; then
            echo "üîµ Current Active: BLUE"
            TARGET_COLOR="green"
            IDLE_OVERLAY="k8s/overlays/prod-green"
          elif [[ "$ACTIVE_SERVICE" == "prod-green-mdas-ci-practice" ]]; then
            echo "üü¢ Current Active: GREEN"
            TARGET_COLOR="blue"
            IDLE_OVERLAY="k8s/overlays/prod-blue"
          else
            echo "‚ö™ No active route found (First run). Defaulting to BLUE deployment."
            TARGET_COLOR="blue"
            IDLE_OVERLAY="k8s/overlays/prod-blue"
          fi

          echo "üöÄ Deploying to IDLE Environment: $TARGET_COLOR"

          # Update Image Tag in Idle Overlay
          cd $IDLE_OVERLAY
          kustomize edit set image ghcr.io/${{ github.repository }}:prod-${{ github.sha }}
          cd - > /dev/null

          # Deploy to Idle Color
          oc apply -k $IDLE_OVERLAY

          # Wait for Readiness
          echo "‚è≥ Waiting for $TARGET_COLOR deployment to be ready..."
          oc rollout status deployment/prod-$TARGET_COLOR-mdas-ci-practice -n rylangraham02-dev --timeout=5m

          # Switch Traffic
          if [[ "$ACTIVE_SERVICE" == "none" ]]; then
            echo "üÜï Creating Main Route (prod-mdas-ci-practice)..."
            oc expose service prod-$TARGET_COLOR-mdas-ci-practice --name=prod-mdas-ci-practice -n rylangraham02-dev
          else
            echo "üîÄ Switching traffic to $TARGET_COLOR..."
            oc patch route prod-mdas-ci-practice -n rylangraham02-dev -p "{\"spec\":{\"to\":{\"name\":\"prod-$TARGET_COLOR-mdas-ci-practice\"}}}"
          fi

          echo "‚úÖ SUCCESS: Traffic is now served by $TARGET_COLOR üöÄ"


  smoke-tests:
    runs-on: ubuntu-latest
    needs: openshift-deploy
    steps:
      - name: Run smoke tests
        run: |
          echo "üß™ Running production smoke tests..."
          PROD_URL="http://prod-mdas-ci-practice-rylangraham02-dev.apps.rm1.0a51.p1.openshiftapps.com"
          
          echo "Checking URL: $PROD_URL"
          for i in {1..5}; do
            if curl -f -I "$PROD_URL"; then
              echo "‚úÖ Endpoint is reachable and returned 200 OK!"
              echo "‚úÖ Smoke tests passed!"
              exit 0
            fi
            echo "‚ö†Ô∏è Endpoint verification failed (Attempt $i/5). Retrying in 10s..."
            sleep 10
          done
          
          echo "‚ùå Smoke tests FAILED after 5 attempts."
          exit 1
